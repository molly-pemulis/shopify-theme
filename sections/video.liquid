{% schema %}
{
  "name": "Product Guide",
  "settings": [
    {
      "type": "text",
      "id": "guide_title",
      "label": "Guide Title"
    },
    {
      "type": "richtext",
      "id": "guide_description",
      "label": "Guide Description"
    },
    {
      "type": "image_picker",
      "id": "guide_image",
      "label": "Guide Image"
    }
  ],
  "blocks": [
    {
      "type": "model",
      "name": "Product Model",
      "settings": [
        {
          "type": "text",
          "id": "model_name",
          "label": "Model Name"
        },
        {
          "type": "richtext",
          "id": "model_description",
          "label": "Model Description"
        },
        {
          "type": "image_picker",
          "id": "model_image",
          "label": "Model Image"
        },
        {
          "id": "video_shopify",
          "type": "video",
          "label": "Model Video Upload",
          "info": "Video hosted by Shopify. Replaces External video if both are set."
        },
        {
          "id": "video_external",
          "type": "text",
          "label": "External Video URL",
          "info": "Supports YouTube and Vimeo."
        },
        {
          "type": "text",
          "id": "video_description",
          "label": "Video Description",
          "info": "Describe the video for customers using screen readers."
        },
        {
          "id": "placeholder_image",
          "type": "image_picker",
          "label": "Custom Cover Image",
          "info": "Choose an image the same shape as your video."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Guide",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<div class="product-guide">
  {% if section.settings.guide_title %}
    <h1>{{ section.settings.guide_title }}</h1>
  {% endif %}
  
  {% if section.settings.guide_image %}
    <img src="{{ section.settings.guide_image | img_url: 'medium' }}" alt="{{ section.settings.guide_title }}" class="guide-image" />
  {% endif %}
  
  {% if section.settings.guide_description %}
    <div class="guide-description">{{ section.settings.guide_description }}</div>
  {% endif %}

  {% for block in section.blocks %}
    <div class="product-model">
      {% if block.settings.model_name %}
        <h2>{{ block.settings.model_name }}</h2>
      {% endif %}
      
      {% if block.settings.model_image %}
        <img src="{{ block.settings.model_image | img_url: 'medium' }}" alt="{{ block.settings.model_name }}" />
      {% endif %}

      {% if block.settings.model_description %}
        <div class="model-description">{{ block.settings.model_description }}</div>
      {% endif %}

      {% if block.settings.video_shopify != blank or block.settings.video_external != blank %}
        {% liquid
          assign using_video_tag = false
          if block.settings.video_shopify != blank
            assign using_video_tag = true
          endif

          if block.settings.placeholder_image
            assign placeholder_image = block.settings.placeholder_image
          elsif block.settings.video_shopify
            assign placeholder_image = block.settings.video_shopify.preview_image
          endif
        %}

        <div class="video-section">
          <div class="height--adapt height--adapt-to-overlay-mobile image-overlay">
            <div class="image-overlay__image height__image">
              <deferred-media>
                <button type="button" class="js-load-media hidden" aria-hidden="true"></button>
                <template>
                  <video-component class="{% if using_video_tag %}has-video{% else %}has-iframe{% endif %}" 
                    {%- unless using_video_tag %} data-video-url="{{ block.settings.video_external | escape }}"{% endunless %}
                    data-video-id="{{ block.id }}"
                    data-autoplay="false"
                    data-background="false"
                    data-description="{{ block.settings.video_description | escape }}">
                    {%- if using_video_tag -%}
                      {{ block.settings.video_shopify | video_tag: playsinline: true, controls: true, autoplay: false, muted: false, loop: false, poster: '' | replace: '<img ', '<img loading="lazy" hidden ' }}
                    {%- else -%}
                      <div></div>
                    {%- endif -%}
                  </video-component>
                </template>
              </deferred-media>

              {% if placeholder_image %}
                {%- render 'image' with placeholder_image, class: 'video-played-hidden' -%}
              {% else %}
                <div class="placeholder-image video-played-hidden">{{- 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' -}}</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<style>
  .product-guide {
    margin: 20px 0;
    text-align: center; /* Center text for the entire product guide */
  }

  .product-model {
    border: 1px solid #ccc;
    margin: 10px 0;
    padding: 15px;
    text-align: center; /* Center text for each product model */
  }

  h1,
  h2 {
    color: #333;
    margin: 15px 0; /* Vertical margins for spacing */
  }

  .guide-description,
  .model-description {
    margin: 10px 0;
    color: #555;
    text-align: center; /* Center text for descriptions */
  }

  img {
    max-width: 100%;
    height: auto;
    margin-bottom: 10px;
  }

  .guide-image {
    margin-bottom: 10px; /* Margin specifically for guide images */
  }

  .video-section {
    margin-top: 20px; /* Space above the video section */
  }
</style>

<script>
if (!customElements.get('video-section-play-button')) {
  class VideoSectionPlayButton extends HTMLElement {
    connectedCallback() {
      this.addEventListener('click', this.handleClick);
    }

    handleClick(evt) {
      const section = evt.target.closest('.video-section');
      section.querySelector('.js-load-media').click();
      setTimeout(() => section.classList.add('video-section--played'), Shopify.designMode ? 500 : 1500);
    }
  }
  customElements.define('video-section-play-button', VideoSectionPlayButton);
}
</script>